!
no service pad
service tcp-keepalives-in
service tcp-keepalives-out
service timestamps debug datetime msec localtime show-timezone year
service timestamps log datetime msec localtime show-timezone year
service password-encryption
!
hostname {{ HOSTNAME }}
!
boot-start-marker
boot system flash:/{{ IMAGE }}
boot-end-marker
!
!
vrf definition Front
 !
 address-family ipv4
 exit-address-family
!
vrf definition Front_Cellular
 !
 address-family ipv4
 exit-address-family
!
logging buffered 1024000
no logging console
logging monitor informational
enable secret 5 $1$TQE1$NnmdH.puSalOMu5HQgRDP.
!
aaa new-model
!
!
aaa group server tacacs+ Moscow
 server name psn001
 server name psn002
!
aaa authentication login default group Moscow local
aaa authentication enable default enable
aaa authorization console
aaa authorization exec default group Moscow local 
aaa accounting exec default start-stop group Moscow
aaa accounting commands 1 default start-stop group Moscow
aaa accounting commands 15 default start-stop group Moscow
!
!
!
!
!
!
aaa session-id common
process cpu threshold type total rising 70 interval 5 falling 50 interval 5
clock timezone {{ TZ_CODE }} {{ TZ_HRS_OFFSET }} 0
!
crypto pki trustpoint Vimpelcom_InternalCA_G2
 enrollment mode ra
 enrollment url http://scep001.bee.vimpelcom.ru:80/certsrv/mscep/mscep.dll
 serial-number
 fqdn {{ HOSTNAME }}.vimpelcom.ru
 subject-name cn={{ HOSTNAME }}.vimpelcom.ru,C=RU,O=Vimpelcom,L={{ LOCATION }}
 subject-alt-name {{ HOSTNAME }}.vimpelcom.ru
 revocation-check none
 rsakeypair Vimpelcom_InternalCA_G2 2048
 auto-enroll {{ ENROLL }} regenerate
!
!
!
crypto pki certificate map CERT_MAP_G2 10
 issuer-name co cn = vimpelcom internalca g2
!
!
!
!
!
no ip source-route
ip arp proxy disable
no ip gratuitous-arps
!
!
!
!
!
!
!
ip domain list vimpelcom.ru
ip domain list bee.vimpelcom.ru
no ip domain lookup
ip domain name vimpelcom.ru
ip host scep001.bee.vimpelcom.ru 172.21.232.154
ip name-server 192.168.163.160
ip name-server 192.168.175.161
ip cef
no ipv6 cef
!
!
!
!
multilink bundle-name authenticated
!
!
chat-script lte "" "AT!CALL" TIMEOUT 20 "OK"
!
!
!
archive
 log config
  logging enable
  hidekeys
username admin privilege 15 secret 5 $1$NTGC$CAgCjExQ0zz0Iqf3eROAM0
!
redundancy
!
!
!
bfd-template single-hop bfd_DMVPN
 interval min-tx 1000 min-rx 1000 multiplier 5
!
!
!
controller Cellular 0
 lte modem link-recovery rssi onset-threshold -110
 lte modem link-recovery monitor-timer 20
 lte modem link-recovery wait-timer 10
 lte modem link-recovery debounce-count 6
!
ip tcp selective-ack
ip tcp mss 1232
ip tcp window-size 65535
ip tcp path-mtu-discovery
!
!
crypto isakmp policy 5
 encr aes 256
 group 5
 lifetime {{ ISAKMP_LIFETIME }}
!
crypto isakmp invalid-spi-recovery
crypto isakmp keepalive 65 5
crypto isakmp profile ISAKMP_G2
   self-identity fqdn
   ca trust-point Vimpelcom_InternalCA_G2
   match certificate CERT_MAP_G2
!
!
crypto ipsec transform-set AES256_TUN esp-aes 256 esp-sha-hmac 
 mode tunnel
crypto ipsec transform-set AES256 esp-aes 256 esp-sha-hmac 
 mode transport
!
crypto ipsec profile IPSEC_G2_BKP1
 set transform-set AES256 
 set isakmp-profile ISAKMP_G2
!
!
!
crypto map INET_G2 100 ipsec-isakmp 
 set peer {{ TUNNEL_4000_HUB_1_NBMA }}
 set transform-set AES256_TUN 
 set isakmp-profile ISAKMP_G2
 match address 140
!
!
!
!
!
!
interface Loopback1
 description -= Transport Loopback =-
 vrf forwarding Front
 ip address {{ TUNNEL_4000_IP }} 255.255.255.255
!
interface Tunnel3000
 description -= BACKUP Tunnel =-
 ip address {{ TUNNEL_3000_IP }} 255.255.255.0
 no ip redirects
 ip mtu 1272
 ip nhrp authentication {{ TUNNEL_3000_NHRP_KEY }}
 ip nhrp network-id {{ TUNNEL_3000_NHRP_ID }}
 ip nhrp nhs {{ TUNNEL_3000_HUB_1_IP }} nbma {{ TUNNEL_3000_HUB_1_NBMA }}
 ip nhrp registration no-unique
 ip tcp adjust-mss 1232
 load-interval 30
 tunnel source Cellular0
 tunnel destination {{ TUNNEL_3000_HUB_1_NBMA }}
 tunnel key {{ TUNNEL_3000_TUNNEL_KEY }}
 tunnel vrf Front_Cellular
 tunnel protection ipsec profile IPSEC_G2_BKP1
!
interface Tunnel4000
 description -= ACTIVE Tunnel =-
 ip address {{ TUNNEL_4000_IP }} 255.255.255.0
 no ip redirects
 ip mtu 1272
 ip nhrp authentication {{ TUNNEL_4000_NHRP_KEY }}
 ip nhrp network-id {{ TUNNEL_4000_NHRP_ID }}
 ip nhrp nhs {{ TUNNEL_4000_HUB_1_IP }} nbma {{ TUNNEL_4000_HUB_1_NBMA }}
 ip nhrp registration no-unique
 ip tcp adjust-mss 1232
 load-interval 30
 bfd template bfd_DMVPN
 tunnel source Loopback1
 tunnel mode gre multipoint
 tunnel key {{ TUNNEL_4000_TUNNEL_KEY }}
 tunnel vrf Front
!
interface Cellular0
 vrf forwarding Front_Cellular
 ip address negotiated
 ip access-group OUTSIDE_IN in 
 encapsulation slip
 load-interval 30
 dialer in-band
 dialer string lte
 dialer watch-group 1
 dialer-group 1
 no peer default ip address
 async mode interactive
 routing dynamic
!
!
interface FastEthernet0
 shut
!
interface FastEthernet1
 shut
!
interface FastEthernet2
 shut
!
interface FastEthernet3
 description -= Link to SW =-
 switchport mode trunk
!
interface GigabitEthernet0
 description {{ GIG_0_DESCRIPTION }}
 vrf forwarding Front
 ip address {{ GIG_0_ADDRESS }}
 ip access-group OUTSIDE_IN in
 no ip redirects
 no ip unreachables
 no ip proxy-arp
 ip mtu 1382
 load-interval 30
 duplex auto
 speed auto
 no cdp enable
 crypto map INET_G2
 no shutdown
!
interface Vlan1
 no ip address
 shutdown
!
vlan 10
 name LAN
!
interface Vlan10
 description -= LAN =-
 ip address {{ VLAN_10_ROUTER_IP }} {{ VLAN_10_MASK }}
 ip helper-address {{ VLAN_10_IP_HELPER_1 }}
 ip helper-address {{ VLAN_10_IP_HELPER_2 }}
 no ip proxy-arp
 ip mtu 1272
 ip tcp adjust-mss 1232
 load-interval 30
 no shutdown
!
router bgp 64995
 bgp router-id {{ VLAN_10_ROUTER_IP }}
 bgp log-neighbor-changes
 no bgp default ipv4-unicast
 neighbor ACTIVE peer-group
 neighbor ACTIVE remote-as 64995
 neighbor ACTIVE description -= primary session via local hub =-
 neighbor ACTIVE password {{ TUNNEL_4000_BGP_PASSWORD }}
 neighbor ACTIVE update-source Tunnel4000
 neighbor ACTIVE fall-over bfd
 neighbor BACKUP peer-group
 neighbor BACKUP remote-as 64995
 neighbor BACKUP description -= backup session via SKL =-
 neighbor BACKUP password 7 {{ TUNNEL_3000_BGP_PASSWORD }}
 neighbor BACKUP update-source Tunnel3000
 neighbor {{ TUNNEL_3000_HUB_1_IP }} peer-group BACKUP
 neighbor {{ TUNNEL_4000_HUB_1_IP }} peer-group ACTIVE
 !
 address-family ipv4
  bgp scan-time 5
  redistribute connected route-map LAN
  neighbor ACTIVE send-community both
  neighbor ACTIVE weight 20
  neighbor ACTIVE prefix-list LAN out
  neighbor ACTIVE maximum-prefix 100 10 restart 1
  neighbor BACKUP send-community both
  neighbor BACKUP advertise-map LAN non-exist-map NON-EXIST-MAP
  neighbor BACKUP weight 10
  neighbor BACKUP prefix-list LAN out
  neighbor BACKUP maximum-prefix 100 10 restart 1
  neighbor {{ TUNNEL_3000_HUB_1_IP }} activate
  neighbor {{ TUNNEL_4000_HUB_1_IP }} activate
  maximum-paths 2
 exit-address-family
!
ip forward-protocol nd
no ip http server
no ip http secure-server
!
ip bgp-community new-format
!
ip route vrf Front {{ TUNNEL_4000_HUB_1_NBMA }} 255.255.255.255 GigabitEthernet0 {{ GIG_0_DEFAULT_GW }}
ip route vrf Front_Cellular {{ TUNNEL_3000_HUB_1_NBMA }} 255.255.255.255 Cellular0
ip tacacs source-interface Vlan10
ip ssh rsa keypair-name SSH
ip ssh version 2
ip scp server enable
!
object-group service DMVPN 
 udp eq isakmp
 udp eq non500-isakmp
 esp
 tcp eq 22
 udp eq 0
!
object-group network HUB 
 host 217.118.86.28
 host {{ TUNNEL_3000_HUB_1_NBMA }}
 host {{ TUNNEL_4000_HUB_1_NBMA }}
!
ip access-list extended OUTSIDE_IN
 remark ### DMVNP
 permit object-group DMVPN object-group HUB any
 remark ### ICMP
 permit icmp any any unreachable
 permit icmp any any echo
 permit icmp any any echo-reply
!
ip prefix-list LAN seq 5 permit {{ VLAN_10_NETWORK }}/{{ VLAN_10_MASK_LENGTH }}
!
ip prefix-list LOCAL_HUB seq 5 permit {{ TUNNEL_4000_HUB_1_LOOPBACK }}/32
ip sla responder
logging monitor informational
logging trap notifications
logging source-interface Vlan10
logging host 192.168.192.128
logging host 172.21.205.104
logging host 192.168.182.173
dialer watch-list 1 ip 5.6.7.8 0.0.0.0
dialer watch-list 1 delay route-check initial 60
dialer watch-list 1 delay connect 1
dialer-list 1 protocol ip permit
!
route-map NON-EXIST-MAP permit 10
 match ip address prefix-list LOCAL_HUB
!
route-map LAN permit 10
 match ip address prefix-list LAN
 set community 64995:2{{ TUNNEL_4000_HUB_1_CAR_CODE }}
!
snmp-server community {{ SNMP_COMMUNITY_RO }} RO 2
snmp-server community {{ SNMP_COMMUNITY_RW }} RW 3
snmp-server ifindex persist
snmp-server trap link ietf
snmp-server trap-source Vlan10
snmp-server location {{ SNMP_LOCATION }}
snmp-server contact {{ SNMP_CONTACT }}
snmp-server host 172.21.205.104 version 2c 6}sU-pSr 
snmp-server host 172.21.205.105 version 2c 6}sU-pSr 
snmp-server host 172.21.205.111 version 2c 6}sU-pSr
snmp mib persist cbqos
snmp-server enable traps
tacacs server psn001
 address ipv4 10.50.65.253
 key 7 097F5B3929000521020F162F3F
tacacs server psn002
 address ipv4 10.50.65.254
 key 7 097F5B3929000521020F162F3F
access-list 1 remark "VTY access"
access-list 1 permit 10.10.10.10
access-list 1 permit 172.25.183.7
access-list 1 permit 172.26.197.117
access-list 1 permit 172.26.197.123
access-list 1 permit 192.168.189.223
access-list 1 permit 192.168.1.127
access-list 1 permit 10.245.245.18
access-list 1 permit 172.21.205.111
access-list 1 permit 172.25.183.25
access-list 1 permit 172.21.205.104
access-list 1 permit 172.21.205.105
access-list 1 permit 172.25.20.130
access-list 1 permit 192.168.192.128
access-list 1 permit 192.168.194.128
access-list 1 permit 172.25.30.135
access-list 1 permit 172.27.185.57
access-list 1 permit 192.168.190.236
access-list 1 permit 172.26.45.222
access-list 1 permit 172.24.132.121
access-list 1 permit 192.168.211.241
access-list 1 permit 172.26.128.122
access-list 1 permit 172.26.200.50
access-list 1 permit 172.26.231.29
access-list 1 permit 192.168.211.245
access-list 1 permit 10.51.119.1
access-list 1 permit 172.26.128.98
access-list 1 permit 10.51.111.1
access-list 1 permit 172.27.146.125
access-list 1 permit 192.168.109.92
access-list 1 permit 192.168.176.130
access-list 1 permit 192.168.109.91
access-list 1 permit 192.168.1.54
access-list 1 permit 192.168.109.90
access-list 1 permit 192.168.163.173
access-list 1 permit 172.26.28.195
access-list 1 permit 10.245.245.103
access-list 1 permit 192.168.1.26
access-list 1 permit 192.168.182.173
access-list 1 permit 192.168.160.190
access-list 1 permit 10.10.2.128
access-list 1 permit 172.25.185.132
access-list 1 permit 172.25.185.130
access-list 1 permit 172.25.20.50
access-list 1 permit 172.21.225.195
access-list 1 permit 172.21.225.196
access-list 1 permit 172.27.0.19
access-list 1 permit 172.25.15.8
access-list 1 permit 172.25.183.183
access-list 1 permit 172.25.21.101
access-list 1 permit 172.25.21.102
access-list 1 permit 172.25.21.106
access-list 1 permit 172.25.21.107
access-list 1 permit 172.26.28.103
access-list 1 permit 192.168.194.127
access-list 1 permit 192.168.182.9
access-list 1 permit 192.168.188.14
access-list 1 permit 192.168.188.9
access-list 1 permit 192.168.137.63
access-list 1 permit 10.255.0.17
access-list 1 permit 217.118.86.28
access-list 1 permit 10.255.0.19
access-list 1 permit 10.10.2.239
access-list 1 permit 172.26.197.142
access-list 1 permit 172.26.128.200
access-list 1 permit 10.127.84.222
access-list 1 permit 10.50.63.0 0.0.0.255
access-list 1 permit 172.27.134.0 0.0.1.255
access-list 1 permit 172.27.4.0 0.0.0.127
access-list 1 permit 192.168.177.0 0.0.0.255
access-list 1 permit 192.168.198.0 0.0.0.255
access-list 2 remark "SNMP RO access"
access-list 2 permit 172.26.197.119
access-list 2 permit 172.26.197.117
access-list 2 permit 192.168.189.223
access-list 2 permit 172.21.230.85
access-list 2 permit 10.245.245.1
access-list 2 permit 192.168.1.127
access-list 2 permit 10.245.245.18
access-list 2 permit 172.21.205.111
access-list 2 permit 172.21.205.104
access-list 2 permit 172.21.205.105
access-list 2 permit 172.27.0.149
access-list 2 permit 172.25.20.130
access-list 2 permit 192.168.192.128
access-list 2 permit 192.168.194.128
access-list 2 permit 172.25.30.135
access-list 2 permit 192.168.190.236
access-list 2 permit 172.24.132.121
access-list 2 permit 172.26.128.98
access-list 2 permit 192.168.109.92
access-list 2 permit 192.168.176.130
access-list 2 permit 192.168.109.91
access-list 2 permit 192.168.1.54
access-list 2 permit 192.168.137.135
access-list 2 permit 192.168.163.173
access-list 2 permit 192.168.182.173
access-list 2 permit 192.168.160.190
access-list 2 permit 10.10.2.128
access-list 2 permit 172.25.185.130
access-list 2 permit 172.25.20.50
access-list 2 permit 172.21.225.195
access-list 2 permit 172.21.225.196
access-list 2 permit 172.25.15.8
access-list 2 permit 172.27.0.14
access-list 2 permit 172.25.21.101
access-list 2 permit 172.25.21.102
access-list 2 permit 172.25.21.106
access-list 2 permit 172.25.21.107
access-list 2 permit 172.26.204.170
access-list 2 permit 192.168.194.127
access-list 2 permit 172.25.20.119
access-list 2 permit 192.168.182.9
access-list 2 permit 172.26.197.151
access-list 2 permit 10.10.2.239
access-list 2 permit 172.21.250.184
access-list 2 permit 172.26.128.200
access-list 2 permit 192.168.198.0 0.0.0.255
access-list 2 permit 192.168.177.0 0.0.0.255
access-list 2 permit 10.50.63.128 0.0.0.127
access-list 2 permit 172.27.4.0 0.0.0.127
access-list 3 remark "SNMP RW access"
access-list 3 permit 172.26.197.117
access-list 3 permit 172.25.20.130
access-list 3 permit 192.168.192.128
access-list 3 permit 192.168.194.128
access-list 3 permit 172.24.132.121
access-list 3 permit 192.168.109.92
access-list 3 permit 192.168.176.130
access-list 3 permit 192.168.109.91
access-list 3 permit 192.168.1.54
access-list 3 permit 192.168.182.173
access-list 3 permit 172.25.15.8
access-list 3 permit 172.25.21.102
access-list 3 permit 172.25.21.106
access-list 3 permit 172.25.21.107
access-list 3 permit 172.25.20.119
access-list 3 permit 192.168.198.0 0.0.0.255
access-list 3 permit 10.50.63.128 0.0.0.127
access-list 140 permit gre host {{ TUNNEL_4000_IP }} host {{ TUNNEL_4000_HUB_1_NBMA }}
!
!
!
control-plane
!
!
!
!
!
line con 0
 exec-timeout 30 0
 logging synchronous
 no modem enable
 transport preferred none
line aux 0
 no exec
 transport preferred none
 transport output none
line 2
 no activation-character
 no exec
 transport preferred none
line 3
 script dialer lte
 modem InOut
 no exec
line vty 0 4
 access-class 1 in vrf-also
 exec-timeout 30 0
 logging synchronous
 transport preferred none
 transport input telnet ssh
 transport output telnet ssh
line vty 5 15
 access-class 1 in vrf-also
 exec-timeout 30 0
 logging synchronous
 transport preferred none
 transport input telnet ssh
 transport output telnet ssh
!
ntp source Vlan10
ntp update-calendar
ntp server 10.31.129.129
ntp server 192.168.181.42
ntp server 192.168.191.191
!  